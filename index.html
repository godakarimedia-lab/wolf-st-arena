<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WOLF STREET: CPU ARENA (Progress Bar Model)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css?family=Press+Start+2P&family=Rubik+Mono+One&display=swap');

        :root {
            --neon-pink: #ff00ff;
            --neon-cyan: #00ffff;
            --neon-yellow: #ffff00;
            --neon-green: #00ff00;
            --neon-red: #ff0000;
            --dark-blue: #0f0f23;
            --deep-purple: #330033;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: var(--dark-blue);
            margin: 0;
            padding: 20px;
            color: #fff;
            overflow-x: hidden;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(255,0,255,0.06) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0,255,255,0.06) 0%, transparent 20%);
        }

        #game-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(0,0,30,0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 40px var(--neon-cyan);
            border: 2px solid var(--neon-cyan);
        }

        .text-shadow-neon {
            text-shadow: 0 0 5px var(--neon-cyan), 0 0 10px var(--neon-cyan);
        }

        .bot-card {
            background-color: rgba(0, 0, 0, 0.42);
            border-radius: 8px;
            border: 1px solid var(--neon-pink);
            box-shadow: 0 0 8px var(--neon-pink);
            position: relative;
        }

        .log-item {
            font-size: 10px;
            padding: 2px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.06);
        }

        #player-cards-container {
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }

        #visualizer-image {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            animation: pulse-border 1.5s infinite alternate;
        }

        @keyframes pulse-border {
            from { box-shadow: 0 0 10px var(--neon-cyan), 0 0 0 0 rgba(0, 255, 255, 0.2); }
            to { box-shadow: 0 0 20px var(--neon-cyan), 0 0 10px 5px rgba(0, 255, 255, 0.4); }
        }

        #map-container {
            border: 2px solid var(--neon-cyan);
            background-color: rgba(0, 10, 10, 0.85);
            background-image: repeating-linear-gradient(0deg, rgba(0, 255, 255, 0.04) 0, transparent 1px),
                              repeating-linear-gradient(90deg, rgba(0, 255, 255, 0.04) 0, transparent 1px);
            background-size: 20px 20px;
            box-shadow: 0 0 10px var(--neon-cyan);
        }

        .action-btn {
            font-family: 'Rubik Mono One', sans-serif;
            font-size: 10px;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Simple modal styling */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        .modal {
            background: rgba(8,8,20,0.98);
            border: 2px solid var(--neon-cyan);
            padding: 18px;
            border-radius: 10px;
            width: 420px;
            max-width: 92%;
            color: #fff;
            box-shadow: 0 0 30px rgba(0,255,255,0.06);
        }
        .input {
            display:block;
            width:100%;
            padding:8px;
            margin:6px 0 12px;
            background: rgba(255,255,255,0.03);
            border:1px solid rgba(255,255,255,0.06);
            color:#fff;
            border-radius:6px;
            font-family: monospace;
        }

        .small {
            font-size:11px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl text-[var(--neon-yellow)] font-mono text-shadow-neon">WOLF STREET: CPU ARENA</h1>
            <div class="flex items-center gap-3">
                <div id="user-greeting" class="text-xs font-mono">Not signed in</div>
                <button id="btn-login" class="py-1 px-2 rounded" style="background:var(--neon-cyan); color:black;">Sign Up / Login</button>
                <button id="btn-logout" class="py-1 px-2 rounded hidden" style="background:var(--neon-red); color:white;">Logout</button>
            </div>
        </div>

        <div id="game-status" class="p-4 mb-6 rounded-lg font-mono text-center text-sm"
             style="background-color: rgba(0, 50, 50, 0.6); border: 2px solid var(--neon-cyan);">
            <span id="current-turn-display">Awaiting simulation start...</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div id="action-visualizer" class="p-4 rounded-xl shadow-xl border-2 mb-6 lg:mb-0 flex flex-col items-center"
                 style="background-color: rgba(0,0,30,0.8); border-color: var(--neon-pink);">
                <h2 class="text-xl font-bold text-[var(--neon-pink)] mb-3 pb-2 border-b border-[var(--neon-pink)] w-full text-center">
                    <span class="text-shadow-neon">Live Action Visualizer</span>
                </h2>

                <div id="visualizer-content" class="flex flex-col items-center justify-center mb-4">
                    <img id="visualizer-image" src="" alt="Active Player"
                         class="hidden w-32 h-32 object-cover rounded-full border-4 border-[var(--neon-cyan)] shadow-lg">
                    <div id="visualizer-text" class="text-lg mt-4 text-center text-[var(--neon-yellow)] font-mono">Simulation Paused.</div>
                </div>

                <div class="w-full h-48 relative rounded-lg p-2" id="map-container">
                    <h3 class="text-xs text-[var(--neon-pink)] font-mono mb-1 text-center absolute top-0 left-1/2 transform -translate-x-1/2 z-20">WOLF STREET Map</h3>
                </div>
            </div>

            <div id="bot-arena-controls" class="p-4 rounded-xl shadow-xl border-2"
                 style="background-color: rgba(0,0,30,0.8); border-color: var(--neon-cyan);">
                <h2 class="text-xl font-bold text-[var(--neon-cyan)] mb-3 pb-2 border-b border-[var(--neon-cyan)]">
                    <span class="text-shadow-neon">CPU Player Generator & Controls</span>
                </h2>

                <div class="flex space-x-3 mb-4">
                    <button id="toggleBotBtn" class="flex-1 py-2 px-3 rounded-lg font-bold transition duration-300"
                            style="background-color: var(--neon-green); color: black; box-shadow: 0 0 5px var(--neon-green);">
                        <span class="mr-1">‚ñ∂Ô∏è</span> Start Simulation
                    </button>
                    <button id="resetBtn" class="py-2 px-3 rounded-lg font-bold transition duration-300 w-1/4"
                            style="background-color: var(--neon-red); color: white; box-shadow: 0 0 5px var(--neon-red);">
                        Reset
                    </button>
                </div>

                <div class="flex gap-2 mb-3">
                    <button id="addBotBtn" class="w-full py-2 rounded-lg font-bold" style="background-color: var(--deep-purple); color: var(--neon-pink); border: 2px solid var(--neon-pink); box-shadow: 0 0 8px var(--neon-pink);">
                        ‚ûï Add CPU
                    </button>
                    <button id="saveBtn" class="py-2 px-3 rounded-lg" style="background-color: var(--neon-cyan); color: black;">
                        üíæ Save State
                    </button>
                    <button id="loadBtn" class="py-2 px-3 rounded-lg" style="background-color: var(--neon-yellow); color: black;">
                        üîÅ Load State
                    </button>
                </div>

                <div class="mb-2">
                    <label for="botSpeed" class="block text-xs font-medium text-white mb-1">Decision Speed (ms per tick): <span id="speedValue" class="text-[var(--neon-yellow)] font-mono">900</span></label>
                    <input type="range" id="botSpeed" min="400" max="3000" value="900" step="100" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" style="accent-color: var(--neon-cyan);">
                </div>

                <div class="mt-3">
                    <h3 class="text-sm font-bold text-[var(--neon-yellow)] mb-2">Manual Controls (Select a CPU card to enable)</h3>
                    <div id="manual-controls" class="grid grid-cols-2 gap-2 opacity-60">
                        <button id="manual-travel" class="action-btn bg-gray-800">Travel</button>
                        <button id="manual-work" class="action-btn bg-gray-800">Work</button>
                        <button id="manual-coldcall" class="action-btn bg-gray-800">Cold Call</button>
                        <button id="manual-invest" class="action-btn bg-gray-800">Invest</button>
                        <button id="manual-pump" class="action-btn bg-gray-800">Pump Stocks</button>
                        <button id="manual-seminar" class="action-btn bg-gray-800">Host Seminar</button>
                        <button id="manual-coke" class="action-btn bg-gray-800">Take Coke</button>
                        <button id="manual-ludes" class="action-btn bg-gray-800">Take Ludes</button>
                        <button id="manual-upgrade" class="action-btn bg-gray-800">Buy Office Upg</button>
                        <button id="manual-sleep" class="action-btn bg-gray-800">Sleep</button>
                    </div>
                </div>

                <div class="mt-4 p-3 rounded border border-[var(--neon-pink)]" style="background: rgba(0,0,0,0.35);">
                    <h4 class="text-sm text-[var(--neon-pink)] mb-2">Create CPU (Paid)</h4>
                    <p class="text-xs text-gray-300 mb-2">Create premium CPU(s) by paying. After payment, mark the purchase as complete to mint CPUs into your account.</p>
                    <label class="small">Number of CPUs</label>
                    <input id="purchase-count" class="input small" type="number" min="1" value="1" />
                    <label class="small">Price per CPU (USD)</label>
                    <input id="price-per" class="input small" type="number" min="1" value="5" />
                    <!-- PayPal link: developer should replace with real PayPal checkout link or integrate PayPal SDK server-side -->
                    <div class="flex gap-2">
                        <a id="paypal-link" class="py-2 px-3 rounded bg-[var(--neon-yellow)] text-black small" target="_blank" rel="noopener">Open PayPal</a>
                        <button id="confirm-payment" class="py-2 px-3 rounded bg-[var(--neon-cyan)] text-black small">I Paid ‚Äî Add CPUs</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Note: This demo uses a manual confirm for PayPal (no server). For real payments, integrate PayPal server-side and verify payment webhooks.</p>
                </div>

                <div class="mt-4 p-3 rounded border border-[var(--neon-cyan)]" style="background: rgba(0,0,0,0.35);">
                    <h4 class="text-sm text-[var(--neon-cyan)] mb-2">Account Wallet (Solana)</h4>
                    <p class="text-xs text-gray-300 mb-2">Add your Solana wallet address to receive rewards. We'll store it in your account.</p>
                    <input id="solana-wallet-input" class="input small" placeholder="Enter Solana wallet (e.g. So1anaAddr...)" />
                    <button id="save-wallet" class="py-2 px-3 rounded bg-[var(--neon-pink)] text-black small">Save Wallet</button>
                    <p id="wallet-saved-msg" class="text-xs text-green-300 mt-1" style="display:none;">Saved</p>
                </div>

            </div>
        </div>

        <h2 class="text-xl font-bold text-[var(--neon-yellow)] mt-8 mb-3 text-shadow-neon">Active Players</h2>
        <div id="player-cards-container" class="grid gap-4"></div>

        <div class="mt-8 p-4 rounded-xl border-2 border-[var(--neon-pink)]" style="background-color: rgba(0,0,0,0.6);">
            <h3 class="text-base font-bold text-[var(--neon-pink)] mb-2">Simulation Log</h3>
            <div id="game-log" class="h-40 overflow-y-auto font-mono text-gray-300"></div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-backdrop" style="display:none;">
        <div class="modal">
            <h3 class="text-lg text-[var(--neon-yellow)] mb-2">Sign Up / Login</h3>
            <div id="auth-tabs" class="mb-3">
                <button id="tab-login" class="py-1 px-3 rounded bg-[var(--neon-cyan)] mr-2">Login</button>
                <button id="tab-signup" class="py-1 px-3 rounded bg-[var(--neon-pink)]">Sign Up</button>
            </div>

            <div id="login-form">
                <label class="small">Email</label>
                <input id="login-email" class="input" type="email" />
                <label class="small">Password</label>
                <input id="login-password" class="input" type="password" />
                <div class="flex gap-2">
                    <button id="btn-do-login" class="py-2 px-3 rounded bg-[var(--neon-yellow)] text-black">Login</button>
                    <button id="btn-close-auth" class="py-2 px-3 rounded bg-gray-700">Cancel</button>
                </div>
                <p class="small text-gray-300 mt-2">This demo uses client-side auth (insecure). For production, move auth server-side.</p>
            </div>

            <div id="signup-form" style="display:none;">
                <label class="small">Name</label>
                <input id="signup-name" class="input" />
                <label class="small">Email</label>
                <input id="signup-email" class="input" type="email" />
                <label class="small">Password</label>
                <input id="signup-password" class="input" type="password" />
                <div class="flex gap-2">
                    <button id="btn-do-signup" class="py-2 px-3 rounded bg-[var(--neon-green)] text-black">Create Account</button>
                    <button id="btn-close-auth-2" class="py-2 px-3 rounded bg-gray-700">Cancel</button>
                </div>
                <p class="small text-gray-300 mt-2">Accounts are stored locally (demo). Implement real backend for real users and payments.</p>
            </div>
        </div>
    </div>

    <script>
        // ========= Existing Game Logic (preserved and extended) =========
        // For brevity, core game logic is mostly unchanged from the previous file.
        // New ACCOUNT and PAYMENT integration are appended below.

        const IMAGE_MAP = {
            'jordi': 'uploaded:jordi.jpg-5ba732dd-a17b-44ff-b00b-de1220e7c21f',
            'mark': 'uploaded:toon mark.jpg-3d87fdf5-bd45-45b5-b740-19dc046f4063',
            'donnie': 'uploaded:toon donnie.jpg-2132310e-0c06-4b26-87e9-a761e6549506',
            'brad_kim': 'uploaded:brad kim toon.jfif-d2607ba2-b9be-48a8-9034-8fc2df1a5286'
        };

        const MAP_COORDINATES = {
            'home': { x: 10, y: 70, label: 'üè† HOME' },
            'office': { x: 50, y: 15, label: 'üè¢ OFFICE' },
            'market': { x: 85, y: 40, label: 'üìà MARKET' },
            'gym': { x: 30, y: 40, label: 'üí™ GYM' },
            'club': { x: 65, y: 80, label: 'ü•Ç CLUB' },
            'phone': { x: 85, y: 15, label: 'üìû PHONE' }
        };

        const ACTION_DURATION_TICKS = 3;
        const TRAVEL_DURATION_TICKS = 2;
        const MAX_SEC_HEAT = 100;
        const UPGRADE_BASE_COST = 900;

        const BASE_PLAYER_STATE = {
            cash: 500,
            energy: 70,
            location: 'home',
            isDriving: false,
            isBusy: false,
            busyFinishTick: 0,
            currentActionDuration: 0,
            currentAction: 'IDLE',
            currentActionMessage: 'Awaiting instruction...',
            strategy: '',
            id: 0,
            officeUpgrades: 0
        };

        let players = [];
        let isSimulating = false;
        let botIntervalId = null;
        let currentBotSpeed = 900;
        let turnIndex = 0;
        let nextPlayerId = 1;
        let currentTick = 0;
        let secHeat = 0;
        let selectedPlayerId = null;

        // DOM refs
        const currentTurnDisplay = document.getElementById('current-turn-display');
        const gameLogElement = document.getElementById('game-log');
        const toggleBotBtn = document.getElementById('toggleBotBtn');
        const resetBtn = document.getElementById('resetBtn');
        const generateBotBtn = document.getElementById('addBotBtn');
        const botSpeedRange = document.getElementById('botSpeed');
        const speedValueDisplay = document.getElementById('speedValue');
        const playerCardsContainer = document.getElementById('player-cards-container');
        const visualizerImage = document.getElementById('visualizer-image');
        const visualizerText = document.getElementById('visualizer-text');
        const mapContainer = document.getElementById('map-container');
        const saveBtn = document.getElementById('saveBtn');
        const loadBtn = document.getElementById('loadBtn');

        // Manual controls
        const manualControls = {
            travel: document.getElementById('manual-travel'),
            work: document.getElementById('manual-work'),
            coldcall: document.getElementById('manual-coldcall'),
            invest: document.getElementById('manual-invest'),
            pump: document.getElementById('manual-pump'),
            seminar: document.getElementById('manual-seminar'),
            coke: document.getElementById('manual-coke'),
            ludes: document.getElementById('manual-ludes'),
            upgrade: document.getElementById('manual-upgrade'),
            sleep: document.getElementById('manual-sleep')
        };

        // Minimal logger
        function logAction(player, message) {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-item';
            logEntry.innerHTML = `<span style="color:var(--neon-cyan);">${time}</span> | 
                                  <strong style="color:var(--neon-yellow);">${player}</strong> 
                                  <span style="color:var(--neon-pink);"> > </span> ${message}`;
            gameLogElement.prepend(logEntry);
            while (gameLogElement.children.length > 200) gameLogElement.removeChild(gameLogElement.lastChild);
        }

        function getRandomElement(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

        // SEC heat
        function adjustSecHeat(amount) {
            secHeat = Math.max(0, Math.min(MAX_SEC_HEAT, secHeat + amount));
            logAction("SYSTEM", `SEC Heat ${amount >= 0 ? '+' : ''}${amount}. Now ${secHeat}.`);
            if (secHeat >= 90) {
                if (players.length > 0) {
                    const victim = players[Math.floor(Math.random() * players.length)];
                    const fine = Math.min(victim.cash, 400 + Math.floor(Math.random() * 1200));
                    victim.cash -= fine;
                    logAction("SEC", `${victim.name} audited & fined $${fine.toFixed(2)}!`);
                }
                secHeat = Math.floor(secHeat / 2);
            }
        }

        function startBusyAction(player, actionVerb, message, duration = ACTION_DURATION_TICKS) {
            player.isBusy = true;
            player.busyFinishTick = currentTick + duration;
            player.currentActionDuration = duration;
            player.currentAction = actionVerb;
            player.currentActionMessage = message;
            logAction(player.name, `${message} (Busy ${duration} ticks)`);
            updateVisualizer();
        }

        function travel(player, destination) {
            if (player.location === destination) { logAction(player.name, "is already here."); return false; }
            if (player.energy < 10) { logAction(player.name, "failed to travel: Energy too low."); return false; }
            player.energy -= 10;
            player.isBusy = true;
            player.isDriving = true;
            player.busyFinishTick = currentTick + TRAVEL_DURATION_TICKS;
            player.currentActionDuration = TRAVEL_DURATION_TICKS;
            player.currentAction = 'DRIVING';
            player.currentActionMessage = `Traveling to ${destination.toUpperCase()}`;
            logAction(player.name, `traveling to ${destination}`);
            updateVisualizer();
            return true;
        }

        // Actions (same tuned values as previous version)
        function coldCall(player) {
            if (player.location !== 'phone') return travel(player, 'phone');
            if (player.energy < 15) { logAction(player.name, "too tired to cold call."); return false; }
            startBusyAction(player, 'COLD_CALLING', "COLD CALLING...", 2);
            const gain = 140 + (player.officeUpgrades*30);
            player.cash += gain;
            player.energy -= 15;
            logAction(player.name, `cold called, +$${gain.toFixed(2)}.`);
            adjustSecHeat(1 + Math.floor(player.officeUpgrades/2));
            return true;
        }

        function work(player) {
            if (player.location !== 'office') return travel(player, 'office');
            if (player.energy < 18) { logAction(player.name, "too tired to work."); return false; }
            const gain = 180 + (player.officeUpgrades*70);
            startBusyAction(player, 'WORKING', "WORKING HARD...", 2);
            player.cash += gain;
            player.energy -= 18;
            logAction(player.name, `worked, +$${gain.toFixed(2)}.`);
            return true;
        }

        function sleep(player) {
            if (player.location !== 'home') return travel(player, 'home');
            startBusyAction(player, 'SLEEPING', "CATCHING ZzZs...", 3);
            player.energy = Math.min(100, player.energy + 45);
            logAction(player.name, `slept, energy +45.`);
            return true;
        }

        function invest(player) {
            if (player.location !== 'market') return travel(player, 'market');
            if (player.cash < 500) { logAction(player.name, "not enough to invest."); return false; }
            startBusyAction(player, 'INVESTING', "INVESTING...", 3);
            const investAmt = 500 + (player.officeUpgrades*100);
            player.cash -= investAmt;
            const profit = Math.floor(Math.random()*(900+player.officeUpgrades*200)) - 200;
            player.cash += Math.max(-investAmt, profit);
            player.energy -= 6;
            logAction(player.name, `invested $${investAmt}, result $${profit.toFixed(2)}.`);
            adjustSecHeat(1);
            return true;
        }

        function pumpStocks(player) {
            if (player.location !== 'market') return travel(player, 'market');
            if (player.cash < 80) { logAction(player.name, "not enough to seed pump."); return false; }
            startBusyAction(player, 'PUMPING', "PUMPING STOCKS...", 3);
            const seed=80;
            player.cash -= seed;
            const success = Math.random() < 0.55 + (player.officeUpgrades*0.04);
            let net=0;
            if (success) {
                net = seed + Math.floor(Math.random()*800) + (player.officeUpgrades*60);
                player.cash += net;
                logAction(player.name, `pump success, net +$${net.toFixed(2)}.`);
            } else {
                net = -Math.floor(Math.random()*180);
                player.cash += net;
                logAction(player.name, `pump failed, net $${net.toFixed(2)}.`);
            }
            player.energy -= 8;
            adjustSecHeat(5 + Math.floor(Math.abs(net)/300));
            return true;
        }

        function hostSeminar(player) {
            if (player.location !== 'office') return travel(player, 'office');
            if (player.cash < 180) { logAction(player.name, "not enough for seminar."); return false; }
            startBusyAction(player, 'SEMINAR', "HOSTING SEMINAR...", 4);
            const revenue = 320 + (player.officeUpgrades*140);
            player.cash += revenue;
            player.energy -= 22;
            logAction(player.name, `hosted seminar, +$${revenue.toFixed(2)}.`);
            adjustSecHeat(3);
            return true;
        }

        function takeCoke(player) {
            const cost = 110;
            if (player.cash < cost) { logAction(player.name, "can't afford coke."); return false; }
            startBusyAction(player, 'COKE', "TAKING COKE...", 1);
            player.cash -= cost;
            player.energy = Math.min(100, player.energy + 40);
            logAction(player.name, `took coke, energy +40.`);
            adjustSecHeat(8);
            return true;
        }

        function takeLudes(player) {
            const cost = 70;
            if (player.cash < cost) { logAction(player.name, "can't afford ludes."); return false; }
            startBusyAction(player, 'LUDES', "TAKING LUDES...", 1);
            player.cash -= cost;
            player.energy = Math.min(100, player.energy + 25);
            logAction(player.name, `took ludes, energy +25.`);
            adjustSecHeat(4);
            return true;
        }

        function buyOfficeUpgrade(player) {
            if (player.location !== 'office') return travel(player, 'office');
            const cost = Math.floor(UPGRADE_BASE_COST * (1 + player.officeUpgrades * 0.5));
            if (player.cash < cost) { logAction(player.name, "can't afford upgrade."); return false; }
            startBusyAction(player, 'UPGRADE', "BUYING OFFICE UPGRADE...", 2);
            player.cash -= cost;
            player.officeUpgrades += 1;
            logAction(player.name, `bought office upgrade #${player.officeUpgrades} for $${cost}.`);
            adjustSecHeat(2);
            return true;
        }

        // Strategies
        const STRATEGIES = {
            'SURVIVOR': { name: 'The Survivor', logic: survivorBotDecision, imageKey: 'jordi' },
            'GRIND_WOLF': { name: 'The Grind Wolf', logic: grindWolfDecision, imageKey: 'donnie' },
            'SOCIALITE': { name: 'The Socialite', logic: socialiteDecision, imageKey: 'mark' },
            'PUMPER': { name: 'The Pumper', logic: pumperDecision, imageKey: 'donnie' },
            'RISK_TAKER': { name: 'The Risk Taker', logic: riskTakerDecision, imageKey: 'brad_kim' }
        };
        const STRATEGY_KEYS = Object.keys(STRATEGIES);

        function survivorBotDecision(player) {
            if (player.isBusy) return true;
            if (player.energy < 40) {
                if (player.location !== 'home') return travel(player,'home');
                if (player.energy < 75) return sleep(player);
            }
            if (player.cash < 900) {
                if (player.location !== 'office') return travel(player,'office');
                if (player.energy > 18) return work(player);
            }
            if (player.energy < 60 && player.cash >= 70 && Math.random() < 0.2) return takeLudes(player);
            return false;
        }

        function grindWolfDecision(player) {
            if (player.isBusy) return true;
            if (player.energy < 20) {
                if (player.location !== 'home') return travel(player,'home');
                return sleep(player);
            }
            if (player.cash < 4200) {
                if (player.location !== 'phone') return travel(player,'phone');
                if (player.energy > 15) return coldCall(player);
            }
            if (player.cash >= 4200 && player.officeUpgrades < 2) return buyOfficeUpgrade(player);
            if (player.location !== 'home') return travel(player,'home');
            return false;
        }

        function socialiteDecision(player) {
            if (player.isBusy) return true;
            if (player.energy < 30) {
                if (player.location !== 'home') return travel(player,'home');
                return sleep(player);
            }
            if (player.cash < 500) {
                if (player.location !== 'office') return travel(player,'office');
                return work(player);
            }
            if (player.location !== 'club') return travel(player,'club');
            if (player.cash >= 200) {
                if (Math.random() < 0.18 && player.cash >= 110) return takeCoke(player);
                return hostSeminar(player) && false || party(player);
            }
            return false;
        }

        function pumperDecision(player) {
            if (player.isBusy) return true;
            if (player.energy < 30) {
                if (player.location !== 'home') return travel(player,'home');
                return sleep(player);
            }
            if (player.cash >= 1200 && Math.random() < 0.7) {
                if (player.location !== 'market') return travel(player,'market');
                return pumpStocks(player);
            }
            if (player.cash < 500) {
                if (player.location !== 'phone') return travel(player,'phone');
                return coldCall(player);
            }
            if (player.location !== 'office') return travel(player,'office');
            if (player.cash >= (UPGRADE_BASE_COST * (1 + player.officeUpgrades * 0.5))) return buyOfficeUpgrade(player);
            return false;
        }

        function riskTakerDecision(player) {
            if (player.isBusy) return true;
            if (player.energy < 25) {
                if (player.location !== 'home') return travel(player,'home');
                return sleep(player);
            }
            if (Math.random() < 0.5 && player.cash >= 500) {
                if (player.location !== 'market') return travel(player,'market');
                return invest(player);
            }
            if (player.cash >= 300) {
                if (player.location !== 'market') return travel(player,'market');
                return pumpStocks(player);
            }
            if (player.location !== 'phone') return travel(player,'phone');
            return coldCall(player);
        }

        // Simulation loop
        function simulateTurn() {
            if (!isSimulating || players.length === 0) return;
            currentTick++;
            const player = players[turnIndex];
            currentTurnDisplay.textContent = `TICK: ${currentTick} | Current Player: ${player.name}`;

            if (player.isBusy) {
                if (currentTick >= player.busyFinishTick) {
                    player.isBusy = false;
                    if (player.isDriving) {
                        const match = player.currentActionMessage.match(/to\s+([A-Z]+)/);
                        if (match && match[1]) player.location = match[1].toLowerCase();
                        player.isDriving = false;
                        logAction(player.name, `arrived at ${player.location}`);
                    }
                    player.currentActionDuration = 0;
                    player.currentAction = 'IDLE';
                    player.currentActionMessage = 'Ready';
                } else {
                    logAction(player.name, `is ${player.isDriving ? 'DRIVING' : player.currentAction} (${player.busyFinishTick - currentTick} ticks left).`);
                    turnIndex = (turnIndex + 1) % players.length;
                    renderPlayers();
                    updateVisualizer();
                    return;
                }
            }

            const decisionFunction = STRATEGIES[players[turnIndex].strategy].logic;
            const madeDecision = decisionFunction(player);

            if (!madeDecision) {
                player.currentAction = 'IDLE';
                player.currentActionMessage = 'Waiting';
            }

            if (secHeat > 0 && Math.random() < 0.35) adjustSecHeat(-1);

            turnIndex = (turnIndex + 1) % players.length;
            renderPlayers();
            updateVisualizer();
        }

        // Map & visualizer
        function renderMap() {
            if (!mapContainer) return;
            let html = '';
            for (const loc in MAP_COORDINATES) {
                const c = MAP_COORDINATES[loc];
                html += `<div class="absolute flex flex-col items-center justify-center text-xs font-mono text-white" style="left: ${c.x}%; top: ${c.y}%; transform: translate(-50%, -50%);">
                        <span class="p-1 rounded-full text-center" style="background-color: var(--neon-pink); box-shadow: 0 0 8px var(--neon-pink);">${c.label.split(' ')[0]}</span>
                        <span class="mt-1 text-[var(--neon-cyan)] text-shadow-neon">${c.label.split(' ')[1]}</span>
                    </div>`;
            }

            players.forEach(p => {
                const coords = MAP_COORDINATES[p.location] || MAP_COORDINATES['home'];
                const idxSame = players.filter(x => x.location === p.location).findIndex(x => x.id === p.id);
                const offset = idxSame * 4;
                const isActive = players.length && p.id === players[turnIndex].id && isSimulating;
                const pulse = isActive ? 'animate-pulse' : '';
                const borderColor = isActive ? 'border-[var(--neon-yellow)]' : 'border-gray-500';
                const img = IMAGE_MAP[STRATEGIES[p.strategy].imageKey];
                html += `<div class="absolute transition-all duration-700 ease-in-out z-10" title="${p.name} at ${p.location.toUpperCase()}" style="left: ${coords.x + offset}%; top: ${coords.y + offset}%; transform: translate(-50%, -50%);">
                        <img src="${img}" alt="${p.name}" class="w-7 h-7 object-cover rounded-full border-2 ${borderColor} shadow-lg ${pulse}"></div>`;
            });

            html += `<div class="absolute bottom-2 right-2 text-xs font-mono text-white p-1 rounded" style="background-color: rgba(0,0,0,0.6); border:1px solid var(--neon-pink);">
                        SEC HEAT: <span style="color: ${secHeat > 70 ? 'var(--neon-red)' : 'var(--neon-yellow)'}">${secHeat}</span>
                    </div>`;

            mapContainer.innerHTML = html;
        }

        function updateVisualizer() {
            renderMap();
            if (!isSimulating || players.length === 0) {
                visualizerImage.classList.add('hidden');
                visualizerText.innerHTML = "Simulation Paused.<br>Start to see the action!";
                return;
            }
            const player = players[turnIndex];
            const strat = STRATEGIES[player.strategy];
            const img = IMAGE_MAP[strat.imageKey];
            visualizerImage.src = img;
            visualizerImage.classList.remove('hidden');
            let actionDetail = player.isBusy ? player.currentActionMessage.toUpperCase() : 'READY TO ACT';
            let colorClass = player.isBusy ? (player.isDriving ? 'text-[var(--neon-yellow)]' : 'text-[var(--neon-red)]') : 'text-[var(--neon-cyan)]';
            visualizerText.innerHTML = `<span class="text-[var(--neon-pink)] text-lg">${player.name} (${strat.name})</span><br>
                                        <span class="${colorClass} text-xl mt-1 font-bold">${actionDetail}</span>`;
        }

        function renderPlayers() {
            playerCardsContainer.innerHTML = players.map(p => {
                const strat = STRATEGIES[p.strategy];
                const img = IMAGE_MAP[strat.imageKey];
                let status = p.isBusy ? (p.isDriving ? 'DRIVING' : p.currentAction.replace('_',' ')) : 'READY';
                let progressHtml = '';
                if (p.isBusy) {
                    const ticksLeft = p.busyFinishTick - currentTick;
                    const total = p.currentActionDuration || 1;
                    const elapsed = total - ticksLeft;
                    const percent = Math.max(0, Math.min(100, Math.floor((elapsed/total)*100)));
                    progressHtml = `<div class="w-full h-2 bg-gray-800 rounded-full mt-1 overflow-hidden"><div class="h-full rounded-full transition-all duration-300" style="width:${percent}%;background-color:var(--neon-cyan)"></div></div><p class="text-[8px] text-gray-400 mt-[1px]">${ticksLeft} Ticks Left</p>`;
                }
                const selected = selectedPlayerId === p.id;
                const borderLeft = selected ? 'border-left: 5px solid var(--neon-yellow);' : '';
                return `<div class="bot-card p-4 flex items-center transition duration-300 cursor-pointer ${p.isBusy ? 'opacity-80':''}" data-player-id="${p.id}" style="${borderLeft}">
                            <div class="avatar mr-4"><img src="${img}" alt="${p.name}" class="w-12 h-12 object-cover rounded-full border-2 border-[var(--neon-pink)]"></div>
                            <div class="flex-1"><h4 class="text-sm font-bold mb-1 text-[var(--neon-pink)]">${p.name} (ID:${p.id})</h4><p class="text-xs text-gray-400 font-mono">${STRATEGIES[p.strategy].name}</p></div>
                            <div class="ml-4 text-right text-xs font-mono"><p class="text-white">Cash: <span class="text-[var(--neon-green)]">$${p.cash.toFixed(2)}</span></p><p class="text-white">Energy: <span class="${p.energy<40?'text-[var(--neon-red)]':'text-white'}">${p.energy}%</span></p><p class="text-white">Loc: <span class="text-[var(--neon-cyan)]">${p.location.toUpperCase()}</span></p><p class="text-white">Status: <span class="${p.isBusy?'text-red-500':'text-green-500'}">${status}</span></p><p class="text-white">Upgrades: <span class="text-[var(--neon-yellow)]">${p.officeUpgrades}</span></p>${progressHtml}</div></div>`;
            }).join('');

            document.querySelectorAll('.bot-card').forEach(el => {
                el.addEventListener('click', () => {
                    const id = parseInt(el.getAttribute('data-player-id'),10);
                    selectedPlayerId = id === selectedPlayerId ? null : id;
                    Array.from(Object.values(manualControls)).forEach(btn => {
                        btn.parentElement.classList.toggle('opacity-100', selectedPlayerId !== null);
                    });
                    renderPlayers();
                });
            });
        }

        // Manual actions wiring
        function getSelectedPlayer() { return players.find(p => p.id === selectedPlayerId); }
        function manualActionWrapper(actionFn, ...args) {
            const p = getSelectedPlayer();
            if (!p) { logAction("SYSTEM","No CPU selected for manual action."); return; }
            const ok = actionFn(p, ...args);
            if (ok && !isSimulating) { renderPlayers(); updateVisualizer(); }
        }

        document.getElementById('manual-travel').addEventListener('click', () => {
            const p = getSelectedPlayer();
            if (!p) { logAction("SYSTEM","Select a CPU first."); return; }
            const order=['home','office','market','phone','club'];
            const idx=order.indexOf(p.location);
            const dest=order[(idx+1)%order.length];
            manualActionWrapper(travel,dest);
        });
        document.getElementById('manual-work').addEventListener('click', ()=> manualActionWrapper(work));
        document.getElementById('manual-coldcall').addEventListener('click', ()=> manualActionWrapper(coldCall));
        document.getElementById('manual-invest').addEventListener('click', ()=> manualActionWrapper(invest));
        document.getElementById('manual-pump').addEventListener('click', ()=> manualActionWrapper(pumpStocks));
        document.getElementById('manual-seminar').addEventListener('click', ()=> manualActionWrapper(hostSeminar));
        document.getElementById('manual-coke').addEventListener('click', ()=> manualActionWrapper(takeCoke));
        document.getElementById('manual-ludes').addEventListener('click', ()=> manualActionWrapper(takeLudes));
        document.getElementById('manual-upgrade').addEventListener('click', ()=> manualActionWrapper(buyOfficeUpgrade));
        document.getElementById('manual-sleep').addEventListener('click', ()=> manualActionWrapper(sleep));

        // Generate & lifecycle
        function generateNewBot(initial=false) {
            const strategyKey = getRandomElement(STRATEGY_KEYS);
            const strategy = STRATEGIES[strategyKey];
            const newBot = {...JSON.parse(JSON.stringify(BASE_PLAYER_STATE)), name: strategy.name + ' ' + nextPlayerId, strategy: strategyKey, id: nextPlayerId, cash: initial ? BASE_PLAYER_STATE.cash : Math.floor(Math.random()*1200)+100, energy: initial ? BASE_PLAYER_STATE.energy : Math.floor(Math.random()*50)+50, officeUpgrades:0};
            players.push(newBot);
            nextPlayerId++;
            logAction("GEN", `Added ${newBot.name} (${strategy.name}).`);
            renderPlayers();
            if (isSimulating) { clearInterval(botIntervalId); botIntervalId = setInterval(simulateTurn, currentBotSpeed); }
        }

        function createInitialPlayers() {
            players = [];
            nextPlayerId = 1;
            generateNewBot(true);
            generateNewBot(true);
            generateNewBot(true);
            turnIndex = 0;
            currentTick = 0;
            players[0].cash = 650; players[1].cash = 320; players[2].energy = 92;
        }

        // Persistence for simulation (not accounts)
        const STORAGE_KEY = 'wolfstreet_sim_v1';
        function saveState() {
            const payload = { players, secHeat, currentTick, turnIndex, nextPlayerId };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
            logAction("SYSTEM", "Saved simulation to localStorage.");
        }
        function loadState() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) { logAction("SYSTEM","No saved state found."); return; }
            try {
                const payload = JSON.parse(raw);
                players = payload.players || [];
                secHeat = payload.secHeat || 0;
                currentTick = payload.currentTick || 0;
                turnIndex = payload.turnIndex || 0;
                nextPlayerId = payload.nextPlayerId || (players.length+1);
                logAction("SYSTEM","Loaded simulation from localStorage.");
                renderPlayers(); updateVisualizer();
            } catch (e) { logAction("SYSTEM","Failed to load state: "+e.message); }
        }
        saveBtn.addEventListener('click', saveState);
        loadBtn.addEventListener('click', loadState);

        // UI control bindings
        toggleBotBtn.addEventListener('click', ()=> {
            isSimulating = !isSimulating;
            if (isSimulating) {
                if (botIntervalId) clearInterval(botIntervalId);
                simulateTurn();
                botIntervalId = setInterval(simulateTurn, currentBotSpeed);
                toggleBotBtn.innerHTML = '<span class="mr-1">‚è∏Ô∏è</span> Pause Simulation';
                toggleBotBtn.style.backgroundColor = 'var(--neon-yellow)';
                toggleBotBtn.style.boxShadow = '0 0 5px var(--neon-yellow)';
            } else {
                clearInterval(botIntervalId); botIntervalId = null;
                toggleBotBtn.innerHTML = '<span class="mr-1">‚ñ∂Ô∏è</span> Start Simulation';
                toggleBotBtn.style.backgroundColor = 'var(--neon-green)';
                toggleBotBtn.style.boxShadow = '0 0 5px var(--neon-green)';
            }
            updateVisualizer(); renderPlayers();
        });

        resetBtn.addEventListener('click', ()=> {
            if (botIntervalId) clearInterval(botIntervalId);
            isSimulating=false; botIntervalId=null;
            createInitialPlayers();
            gameLogElement.innerHTML=''; secHeat=0; selectedPlayerId=null;
            logAction("SYSTEM","Game reset.");
            renderPlayers(); updateVisualizer();
        });

        generateBotBtn.addEventListener('click', ()=> generateNewBot(false));

        botSpeedRange.addEventListener('input', (e)=> {
            currentBotSpeed = parseInt(e.target.value,10);
            speedValueDisplay.textContent = currentBotSpeed;
            if (isSimulating) { clearInterval(botIntervalId); botIntervalId = setInterval(simulateTurn, currentBotSpeed); }
        });

        // Init
        window.addEventListener('load', ()=> {
            createInitialPlayers();
            renderPlayers(); updateVisualizer();
            speedValueDisplay.textContent = currentBotSpeed;
            Array.from(Object.values(manualControls)).forEach(btn => btn.parentElement.classList.add('opacity-60'));
        });

        // ========= ACCOUNT, PAYMENT, SOLANA WALLET (NEW) =========
        // WARNING: This is a client-side demo/auth. For production, implement server-side auth, secure password storage and payment verification.
        const AUTH_STORAGE = 'wolfstreet_users_v1';
        let currentUser = null;

        // DOM for auth
        const authModal = document.getElementById('auth-modal');
        const btnLogin = document.getElementById('btn-login');
        const btnLogout = document.getElementById('btn-logout');
        const userGreeting = document.getElementById('user-greeting');

        const tabLogin = document.getElementById('tab-login');
        const tabSignup = document.getElementById('tab-signup');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');

        // auth inputs
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const signupName = document.getElementById('signup-name');
        const signupEmail = document.getElementById('signup-email');
        const signupPassword = document.getElementById('signup-password');
        const btnDoLogin = document.getElementById('btn-do-login');
        const btnDoSignup = document.getElementById('btn-do-signup');
        const btnCloseAuth = document.getElementById('btn-close-auth');
        const btnCloseAuth2 = document.getElementById('btn-close-auth-2');

        // wallet elements
        const walletInput = document.getElementById('solana-wallet-input');
        const saveWalletBtn = document.getElementById('save-wallet');
        const walletSavedMsg = document.getElementById('wallet-saved-msg');

        // purchase elements
        const paypalLink = document.getElementById('paypal-link');
        const confirmPaymentBtn = document.getElementById('confirm-payment');
        const purchaseCountInput = document.getElementById('purchase-count');
        const pricePerInput = document.getElementById('price-per');

        function loadUsers() {
            try {
                const raw = localStorage.getItem(AUTH_STORAGE);
                return raw ? JSON.parse(raw) : {};
            } catch(e) { return {}; }
        }
        function saveUsers(users) { localStorage.setItem(AUTH_STORAGE, JSON.stringify(users)); }

        function hashPasswordSimple(pw) {
            // simple client-side hash placeholder (not secure). Replace with server hashing in production.
            let h=0;
            for (let i=0;i<pw.length;i++) h = (h<<5)-h + pw.charCodeAt(i);
            return h.toString();
        }

        function openAuthModal(mode='login') {
            authModal.style.display = 'flex';
            if (mode==='login') { loginForm.style.display='block'; signupForm.style.display='none'; }
            else { loginForm.style.display='none'; signupForm.style.display='block'; }
        }
        function closeAuthModal() { authModal.style.display='none'; }

        btnLogin.addEventListener('click', ()=> openAuthModal('login'));
        btnCloseAuth.addEventListener('click', closeAuthModal);
        btnCloseAuth2.addEventListener('click', closeAuthModal);

        tabLogin.addEventListener('click', ()=> { loginForm.style.display='block'; signupForm.style.display='none'; });
        tabSignup.addEventListener('click', ()=> { loginForm.style.display='none'; signupForm.style.display='block'; });

        btnDoSignup.addEventListener('click', ()=> {
            const name = signupName.value.trim();
            const email = signupEmail.value.trim().toLowerCase();
            const pw = signupPassword.value;
            if (!name || !email || !pw) { alert('Enter name, email and password'); return; }
            const users = loadUsers();
            if (users[email]) { alert('Account exists - please login.'); return; }
            users[email] = { name, email, passwordHash: hashPasswordSimple(pw), cpus: [], solanaWallet: '' };
            saveUsers(users);
            alert('Account created. You are now logged in (demo).');
            signinUser(email);
            closeAuthModal();
        });

        btnDoLogin.addEventListener('click', ()=> {
            const email = loginEmail.value.trim().toLowerCase();
            const pw = loginPassword.value;
            const users = loadUsers();
            if (!users[email] || users[email].passwordHash !== hashPasswordSimple(pw)) { alert('Invalid credentials'); return; }
            signinUser(email);
            closeAuthModal();
        });

        btnLogout.addEventListener('click', ()=> {
            signoutUser();
        });

        function signinUser(email) {
            const users = loadUsers();
            currentUser = users[email];
            if (!currentUser) return;
            userGreeting.textContent = `Signed in: ${currentUser.name}`;
            btnLogin.classList.add('hidden');
            btnLogout.classList.remove('hidden');
            refreshUserDataUI();
        }

        function signoutUser() {
            currentUser = null;
            userGreeting.textContent = 'Not signed in';
            btnLogin.classList.remove('hidden');
            btnLogout.classList.add('hidden');
            walletSavedMsg.style.display='none';
        }

        function refreshUserDataUI() {
            if (!currentUser) return;
            // populate wallet input
            walletInput.value = currentUser.solanaWallet || '';
            walletSavedMsg.style.display = currentUser.solanaWallet ? 'block' : 'none';
            // show user's CPUs in the log summary (also available for debugging)
            logAction("ACCOUNT", `You have ${currentUser.cpus.length} purchased CPUs.`);
        }

        saveWalletBtn.addEventListener('click', ()=> {
            if (!currentUser) { alert('Please sign in first'); return; }
            const addr = walletInput.value.trim();
            // Minimal validation: Solana addresses are usually 32-44 chars base58. This is a weak check.
            if (addr.length < 32 || addr.length > 64) { alert('Please enter a valid wallet address'); return; }
            const users = loadUsers();
            users[currentUser.email].solanaWallet = addr;
            saveUsers(users);
            currentUser.solanaWallet = addr;
            walletSavedMsg.style.display = 'block';
            logAction("ACCOUNT", `Saved Solana wallet for ${currentUser.name}.`);
        });

        // Payment flow (demo):
        // - PayPal button opens a PayPal payment link (developer must replace)
        // - After paying, user presses "I Paid ‚Äî Add CPUs" to confirm. This is manual and insecure for production.
        paypalLink.addEventListener('click', (e) => {
            // Create a PayPal "buy now" URL prefilled with amount. This is a simple helper; replace with correct merchant link.
            const count = parseInt(purchaseCountInput.value,10) || 1;
            const pricePer = parseFloat(pricePerInput.value) || 5;
            const total = (count * pricePer).toFixed(2);
            // Example: link to PayPal.me (merchant should set their PayPal.Me link)
            const merchant = 'YOUR_PAYPAL_ME_NAME'; // <-- REPLACE with your real PayPal.me username
            const url = `https://www.paypal.com/paypalme/${merchant}/${total}`;
            paypalLink.href = url;
        });

        confirmPaymentBtn.addEventListener('click', ()=> {
            if (!currentUser) { alert('Please sign in to receive the purchased CPUs'); return; }
            const count = Math.max(1, parseInt(purchaseCountInput.value,10) || 1);
            // In production: verify payment server-side using PayPal webhooks and then create CPUs.
            // Here: manual "confirm" creates CPU entries and attaches them to the signed-in user's account.
            const users = loadUsers();
            const userRecord = users[currentUser.email];
            for (let i=0;i<count;i++) {
                const strategyKey = getRandomElement(STRATEGY_KEYS);
                const newBot = {
                    ...JSON.parse(JSON.stringify(BASE_PLAYER_STATE)),
                    name: STRATEGIES[strategyKey].name + ' (Purchased) ' + (userRecord.cpus.length + 1),
                    strategy: strategyKey,
                    id: `p-${Date.now()}-${Math.floor(Math.random()*9999)}`,
                    cash: 200 + Math.floor(Math.random()*300),
                    energy: 80,
                    officeUpgrades: 0,
                    purchased: true,
                    ownerEmail: userRecord.email
                };
                // Add to global simulation players as well
                players.push(newBot);
                // Add to user's persistent CPU list
                userRecord.cpus.push(newBot);
            }
            saveUsers(users);
            currentUser = userRecord;
            logAction("PAYMENT", `${currentUser.name} added ${count} purchased CPU(s) to their account.`);
            renderPlayers();
            updateVisualizer();
        });

        // Expose a small UI to list user's purchased CPUs in the log for quick inspect
        function listUserCPUs() {
            if (!currentUser) { logAction("ACCOUNT","Sign in to list your purchased CPUs."); return; }
            logAction("ACCOUNT", `Listing ${currentUser.cpus.length} purchased CPUs:`);
            currentUser.cpus.forEach((c, i) => {
                logAction("CPU", `#${i+1}: ${c.name} (strategy:${c.strategy})`);
            });
        }

        // On load, attempt to rehydrate default demo user if present
        (function tryAutoSignin() {
            const users = loadUsers();
            // If only one user exists, auto sign them in for convenience (demo only)
            const keys = Object.keys(users);
            if (keys.length === 1) {
                signinUser(keys[0]);
            }
        })();

        // Add a small keyboard shortcut: press 'u' to list your purchased CPUs (debug convenience)
        window.addEventListener('keydown', (e) => {
            if (e.key === 'u') listUserCPUs();
        });

    </script>

<script src="avatarSprites.js"></script>
<script>
    // Avatar rendering system (merged from index wsa.html)
    function renderAvatar(avatar) {
        const frameLeft = 64 * avatar.frameIdx;
        let html =
          `<span style="width: 64px; height: 64px; display: inline-block; background-image: url('${avatar.baseImg}'); background-position: -${frameLeft}px 0; background-size: auto 64px; position:relative;"></span>`;
        avatar.equipment.forEach((eq, i) => {
            html += `<img src="${eq}" style="position: absolute; left: ${2 + i * 24}px; top: 44px; width: 20px; height: 20px;"/>`;
        });
        return `<div style="position: relative; width: 64px; height: 64px;">${html}</div>`;
    }

    // Patch generateNewBot and renderPlayers for avatar integration
    const originalGenerateNewBot = generateNewBot;
    generateNewBot = function(initial=false) {
        const strategyKey = getRandomElement(STRATEGY_KEYS);
        const strategy = STRATEGIES[strategyKey];
        const avatarConfig = getRandomCPUAvatarConfig ? getRandomCPUAvatarConfig() : { baseImg: '', frameIdx: 0, equipment: [] };
        const newBot = {
            ...JSON.parse(JSON.stringify(BASE_PLAYER_STATE)),
            name: strategy.name + ' ' + nextPlayerId,
            strategy: strategyKey,
            id: nextPlayerId,
            avatarConfig,
            cash: initial ? BASE_PLAYER_STATE.cash : (300 + Math.random() * 600 | 0)
        };
        players.push(newBot);
        nextPlayerId++;
        logAction("GEN", `Added ${newBot.name} (${strategy.name}).`);
        renderPlayers();
        if (isSimulating) {
            clearInterval(botIntervalId);
            botIntervalId = setInterval(simulateTurn, currentBotSpeed);
        }
    };

    const originalRenderPlayers = renderPlayers;
    renderPlayers = function() {
        playerCardsContainer.innerHTML = players.map(p => {
            const strat = STRATEGIES[p.strategy];
            let status = p.isBusy ? (p.isDriving ? 'DRIVING' : p.currentAction.replace('_',' ')) : 'READY';
            let progressHtml = '';
            if (p.isBusy) {
                const ticksLeft = p.busyFinishTick - currentTick;
                const total = p.currentActionDuration || 1;
                const elapsed = total - ticksLeft;
                const percent = Math.max(0, Math.min(100, Math.floor((elapsed/total)*100)));
                progressHtml = `<div class="w-full h-2 bg-gray-800 rounded-full mt-1 overflow-hidden"><div class="h-full rounded-full transition-all duration-300" style="width:${percent}%;background:linear-gradient(90deg,var(--neon-yellow),var(--neon-cyan));"></div></div>`;
            }
            const selected = selectedPlayerId === p.id;
            const borderLeft = selected ? 'border-left: 5px solid var(--neon-yellow);' : '';
            const avatarHTML = p.avatarConfig ? renderAvatar(p.avatarConfig) : '<div class="w-12 h-12 bg-gray-700 rounded-full"></div>';
            return `<div class="bot-card p-4 flex items-center transition duration-300 cursor-pointer ${p.isBusy ? 'opacity-80':''}" data-player-id="${p.id}" style="${borderLeft}">
                        <div class="avatar mr-4">${avatarHTML}</div>
                        <div class="flex-1"><h4 class="text-sm font-bold mb-1 text-[var(--neon-pink)]">${p.name} (ID:${p.id})</h4><p class="text-xs text-gray-400 font-mono">${strat.name}</p>${progressHtml}</div>
                        <div class="ml-4 text-right text-xs font-mono"><p class="text-white">Cash: <span class="text-[var(--neon-green)]">$${p.cash.toFixed(2)}</span></p><p class="text-white">Energy: <span class="text-[var(--neon-cyan)]">${p.energy}</span></p><p>Status: <span class="text-[var(--neon-yellow)]">${status}</span></p></div>
                    </div>`;
        }).join('');

        document.querySelectorAll('.bot-card').forEach(el => {
            el.addEventListener('click', () => {
                const id = parseInt(el.getAttribute('data-player-id'),10);
                selectedPlayerId = id === selectedPlayerId ? null : id;
                Array.from(Object.values(manualControls)).forEach(btn => {
                    btn.parentElement.classList.toggle('opacity-100', selectedPlayerId !== null);
                });
                renderPlayers();
            });
        });
    };
</script>

</body>
</html>
